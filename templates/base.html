<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Safe Space Monitor{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/animations.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/activities.css') }}" rel="stylesheet">

    {% block extra_head %}{% endblock %}
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('home') }}">
                <i class="fas fa-shield-alt me-2"></i>
                Safe Space Monitor
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('dashboard') }}">
                            <i class="fas fa-home me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('profile_page') }}">
                            <i class="fas fa-user me-1"></i>Profile
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/activities">
                            <i class="fas fa-heartbeat me-2"></i>Calming Activities
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/sensor-settings">
                            <i class="fas fa-cogs me-2"></i>Sensor Settings
                        </a>
                    </li>
                </ul>
                
                <div class="navbar-nav">
                    <div class="nav-item">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-light btn-sm" id="childViewBtn">
                                <i class="fas fa-child me-1"></i>Child View
                            </button>
                            <button type="button" class="btn btn-outline-light btn-sm active" id="caregiverViewBtn">
                                <i class="fas fa-user-md me-1"></i>Caregiver View
                            </button>
                        </div>
                    </div>
                    <li class="nav-item">
                        <span class="nav-link" id="connectionStatus">
                            <i class="fas fa-circle text-success me-1"></i>
                            <span>Connected</span>
                        </span>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="alertsDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-bell me-1"></i>
                            <span id="alertCount" class="badge bg-danger">0</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" id="alertsList">
                            <li><h6 class="dropdown-header">Recent Alerts</h6></li>
                            <li><a class="dropdown-item text-muted" href="#">No new alerts</a></li>
                        </ul>
                    </li>
                </div>
            </div>
        </div>
    </nav>

    <!-- Real-time Alert Banner -->
    <div class="alert-banner alert alert-warning alert-dismissible fade show mb-0 text-center d-none" role="alert" id="overloadAlert">
        <div class="container">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong id="alertTitle">Sensory Overload Detected</strong>
            <span id="alertMessage">High noise levels detected. Consider moving to a quieter space.</span>
            <button type="button" class="btn btn-sm btn-outline-warning ms-3" id="quickCalmBtn">
                <i class="fas fa-heartbeat me-1"></i>Quick Calm
            </button>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>

    <!-- Main Content -->
    <main>
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-light mt-5 py-3">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-0 text-muted">
                        <i class="fas fa-shield-alt me-1"></i>
                        Safe Space Monitor - Sensory Regulation Support
                    </p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0 text-muted">
                        <i class="fas fa-brain me-1"></i>
                        AI-Powered Real-time Monitoring
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Status Indicator -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050;">
        <div class="toast" id="statusToast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="fas fa-circle text-success me-2" id="statusIcon"></i>
                <strong class="me-auto" id="statusTitle">System Status</strong>
                <small id="statusTime">Just now</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="statusMessage">
                <i class="fas fa-check-circle me-2 text-success"></i>
                System initialized successfully
            </div>
        </div>
    </div>

    <!-- Quick Calm Modal -->
    <div class="modal fade" id="quickCalmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-heartbeat me-2"></i>Quick Calm Exercise
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="breathing-animation mb-4">
                        <div class="circle" id="breathCircle"></div>
                    </div>
                    <h4 id="calmInstruction">Breathe in slowly...</h4>
                    <p class="text-muted" id="calmDescription">Follow the circle as it expands and contracts</p>
                    <div class="progress mb-3">
                        <div class="progress-bar bg-success" id="calmProgress" style="width: 0%"></div>
                    </div>
                    <p class="small text-muted" id="calmTimer">30 seconds remaining</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="completeCalmBtn">I'm Feeling Calmer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" id="loadingSpinner" style="background: rgba(255,255,255,0.8); z-index: 1060; display: none !important;">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted" id="loadingText">Loading recommendations...</p>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Global Socket.IO Connection -->
    <script>
        // Global socket connection
        const socket = io();
        let currentUserProfile = null;
        let activeAlerts = [];
        let calmSessionActive = false;

        // Connection status management
        socket.on('connect', function() {
            document.getElementById('connectionStatus').innerHTML = 
                '<i class="fas fa-circle text-success me-1"></i><span>Connected</span>';
            showToast('Real-time connection established', 'success', 'Connected');
        });
        
        socket.on('disconnect', function() {
            document.getElementById('connectionStatus').innerHTML = 
                '<i class="fas fa-circle text-danger me-1"></i><span>Disconnected</span>';
            showToast('Connection lost - attempting to reconnect...', 'warning', 'Disconnected');
        });
        
        socket.on('connect_error', function() {
            document.getElementById('connectionStatus').innerHTML = 
                '<i class="fas fa-circle text-warning me-1"></i><span>Connection Error</span>';
        });

        // Real-time sensor data updates
        socket.on('sensor_update', function(data) {
            if (window.updateSensorDisplays) {
                window.updateSensorDisplays(data.sensor_data);
            }
            if (window.updateDataBuffer) {
                window.updateDataBuffer(data.sensor_data, data.prediction);
            }
            if (window.updateRiskDisplay) {
                window.updateRiskDisplay(data.prediction);
            }
        });

        // Overload alerts
        socket.on('overload_alert', function(alertData) {
            handleOverloadAlert(alertData);
        });

        socket.on('alert', function(alertData) {
            handleOverloadAlert(alertData);
        });

        // Recommendation updates
        socket.on('recommendation_update', function(recommendation) {
            showToast(recommendation.message, 'info', 'Suggestion');
        });

        // User profile updates
        socket.on('profile_updated', function(profile) {
            currentUserProfile = profile;
            showToast('Profile updated successfully', 'success', 'Profile Saved');
        });

        // System status updates
        socket.on('system_status', function(status) {
            updateSystemStatus(status);
        });
    </script>
    
    <!-- Enhanced Utility Functions -->
    <script>
    // Global utility functions
    function showToast(message, type = 'success', title = 'System Notification') {
        const toastEl = document.getElementById('statusToast');
        const toastTitle = document.getElementById('statusTitle');
        const toastMessage = document.getElementById('statusMessage');
        const toastIcon = document.getElementById('statusIcon');
        const statusTime = document.getElementById('statusTime');
        
        // Set content based on type
        toastTitle.textContent = title;
        toastMessage.innerHTML = message;
        statusTime.textContent = new Date().toLocaleTimeString();
        
        // Set icon and color based on type
        const typeConfig = {
            'success': { icon: 'fa-check-circle', color: 'text-success', bg: 'text-success' },
            'error': { icon: 'fa-exclamation-circle', color: 'text-danger', bg: 'text-danger' },
            'warning': { icon: 'fa-exclamation-triangle', color: 'text-warning', bg: 'text-warning' },
            'info': { icon: 'fa-info-circle', color: 'text-info', bg: 'text-info' }
        };
        
        const config = typeConfig[type] || typeConfig.info;
        toastIcon.className = `fas ${config.bg} me-2`;
        toastMessage.innerHTML = `<i class="fas ${config.icon} me-2 ${config.color}"></i>${message}`;
        
        // Show the toast
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }
    
    function showLoading(message = 'Loading...') {
        const spinner = document.getElementById('loadingSpinner');
        const loadingText = document.getElementById('loadingText');
        loadingText.textContent = message;
        spinner.style.display = 'flex';
    }
    
    function hideLoading() {
        const spinner = document.getElementById('loadingSpinner');
        spinner.style.display = 'none';
    }
    
    function formatTime(timestamp) {
        return new Date(timestamp).toLocaleTimeString();
    }

    function updateSensorDisplays(sensorData) {
        // Update any sensor displays on the page
        const sensorElements = document.querySelectorAll('[data-sensor]');
        sensorElements.forEach(element => {
            const sensorType = element.getAttribute('data-sensor');
            if (sensorData[sensorType] !== undefined) {
                // Format the value appropriately
                let displayValue = sensorData[sensorType];
                if (sensorType === 'noise') {
                    displayValue = Math.round(displayValue);
                    element.textContent = displayValue + ' dB';
                } else if (sensorType === 'light') {
                    displayValue = Math.round(displayValue);
                    element.textContent = displayValue + ' lux';
                } else if (sensorType === 'motion') {
                    displayValue = Math.round(displayValue);
                    element.textContent = displayValue + '%';
                } else if (sensorType === 'temperature') {
                    displayValue = displayValue.toFixed(1);
                    element.textContent = displayValue + '°C';
                } else if (sensorType === 'heart_rate') {
                    displayValue = Math.round(displayValue);
                    element.textContent = displayValue + ' BPM';
                } else {
                    element.textContent = displayValue;
                }
                
                // Add visual feedback based on sensor levels
                const thresholds = getSensorThresholds(sensorType);
                if (sensorData[sensorType] > thresholds.danger) {
                    element.classList.add('sensor-danger');
                    element.classList.remove('sensor-warning', 'sensor-normal');
                } else if (sensorData[sensorType] > thresholds.warning) {
                    element.classList.add('sensor-warning');
                    element.classList.remove('sensor-danger', 'sensor-normal');
                } else {
                    element.classList.add('sensor-normal');
                    element.classList.remove('sensor-danger', 'sensor-warning');
                }
            }
        });
    }

    function getSensorThresholds(sensorType) {
        const thresholds = {
            noise: { warning: 70, danger: 100 },
            light: { warning: 5000, danger: 8000 },
            motion: { warning: 60, danger: 80 },
            heart_rate: { warning: 100, danger: 120 },
            temperature: { warning: 28, danger: 32 }
        };
        return thresholds[sensorType] || { warning: 0, danger: 0 };
    }

    function checkForAlerts(sensorData) {
        let alertTriggered = false;
        let alertType = '';
        let alertMessage = '';

        if (sensorData.noise > getSensorThresholds('noise').danger) {
            alertTriggered = true;
            alertType = 'auditory';
            alertMessage = 'High noise levels detected. Consider moving to a quieter space.';
        } else if (sensorData.light > getSensorThresholds('light').danger) {
            alertTriggered = true;
            alertType = 'visual';
            alertMessage = 'Bright light detected. Consider dimming lights or using sunglasses.';
        } else if (sensorData.motion > getSensorThresholds('motion').danger) {
            alertTriggered = true;
            alertType = 'motion';
            alertMessage = 'High activity level detected. Consider taking a movement break.';
        } else if (sensorData.heart_rate > getSensorThresholds('heart_rate').danger) {
            alertTriggered = true;
            alertType = 'physiological';
            alertMessage = 'Elevated heart rate detected. Try calming exercises.';
        }

        if (alertTriggered && !calmSessionActive) {
            socket.emit('overload_detected', {
                type: alertType,
                sensor_data: sensorData,
                timestamp: new Date().toISOString()
            });
        }
    }

    function handleOverloadAlert(alertData) {
        try {
            // Add to active alerts
            activeAlerts.push({
                id: Date.now(),
                type: alertData.type || 'general',
                message: alertData.message || 'Sensory overload detected',
                timestamp: alertData.timestamp || new Date().toISOString(),
                severity: alertData.severity || 'high'
            });

            // Update alert count
            updateAlertCount();

            // Show banner alert
            const alertBanner = document.getElementById('overloadAlert');
            const alertTitle = document.getElementById('alertTitle');
            const alertMessage = document.getElementById('alertMessage');

            if (alertBanner && alertTitle && alertMessage) {
                alertTitle.textContent = getAlertTitle(alertData.type);
                alertMessage.textContent = alertData.message;
                alertBanner.classList.remove('d-none');

                // Auto-hide after 10 seconds if not dismissed
                setTimeout(() => {
                    if (alertBanner && !alertBanner.classList.contains('d-none')) {
                        alertBanner.classList.add('d-none');
                    }
                }, 10000);
            }

            // Show toast notification
            showToast(alertData.message, 'warning', 'Sensory Alert');
            
        } catch (error) {
            console.error('Error handling overload alert:', error);
        }
    }

    function getAlertTitle(alertType) {
        const titles = {
            'auditory': 'Sound Sensitivity Alert',
            'visual': 'Light Sensitivity Alert',
            'motion': 'Activity Level Alert',
            'physiological': 'Physiological Alert',
            'general': 'Sensory Alert'
        };
        return titles[alertType] || 'Sensory Alert';
    }

    function updateAlertCount() {
        const alertCount = document.getElementById('alertCount');
        const alertsList = document.getElementById('alertsList');
        
        if (alertCount) {
            alertCount.textContent = activeAlerts.length;
        }
        
        if (alertsList) {
            // Update dropdown list
            alertsList.innerHTML = '<li><h6 class="dropdown-header">Recent Alerts</h6></li>';
            
            if (activeAlerts.length === 0) {
                alertsList.innerHTML += '<li><a class="dropdown-item text-muted" href="#">No new alerts</a></li>';
            } else {
                activeAlerts.slice(-5).reverse().forEach(alert => {
                    const alertItem = document.createElement('li');
                    alertItem.innerHTML = `
                        <a class="dropdown-item" href="#">
                            <div class="d-flex w-100 justify-content-between">
                                <small class="text-${getAlertColor(alert.severity)}">${getAlertTitle(alert.type)}</small>
                                <small class="text-muted">${formatTime(alert.timestamp)}</small>
                            </div>
                            <small class="text-muted">${alert.message}</small>
                        </a>
                    `;
                    alertsList.appendChild(alertItem);
                });
            }
        }
    }

    function getAlertColor(severity) {
        const colors = {
            'low': 'info',
            'medium': 'warning',
            'high': 'danger'
        };
        return colors[severity] || 'secondary';
    }

    function updateSystemStatus(status) {
        // Update any system status indicators
        console.log('System status update:', status);
    }

    function startCalmSession() {
        calmSessionActive = true;
        const modal = new bootstrap.Modal(document.getElementById('quickCalmModal'));
        modal.show();
        
        // Hide alert banner when calm session starts
        const alertBanner = document.getElementById('overloadAlert');
        if (alertBanner) {
            alertBanner.classList.add('d-none');
        }
        
        // Start breathing animation
        startBreathingAnimation();
    }

    function startBreathingAnimation() {
        const circle = document.getElementById('breathCircle');
        const instruction = document.getElementById('calmInstruction');
        const description = document.getElementById('calmDescription');
        const progress = document.getElementById('calmProgress');
        const timer = document.getElementById('calmTimer');
        
        if (!circle || !instruction) return;
        
        let seconds = 30;
        let phase = 'inhale'; // inhale, hold, exhale
        
        const updateAnimation = () => {
            if (seconds <= 0) {
                completeCalmSession();
                return;
            }
            
            seconds--;
            if (timer) timer.textContent = `${seconds} seconds remaining`;
            if (progress) progress.style.width = `${((30 - seconds) / 30) * 100}%`;
            
            // Breathing cycle: 4s inhale, 2s hold, 6s exhale
            const cycleTime = seconds % 12;
            
            if (cycleTime >= 6) {
                phase = 'exhale';
                instruction.textContent = 'Breathe out slowly...';
                circle.style.transform = 'scale(0.7)';
            } else if (cycleTime >= 4) {
                phase = 'hold';
                instruction.textContent = 'Hold your breath...';
            } else {
                phase = 'inhale';
                instruction.textContent = 'Breathe in slowly...';
                circle.style.transform = 'scale(1.2)';
            }
            
            setTimeout(updateAnimation, 1000);
        };
        
        updateAnimation();
    }

    function completeCalmSession() {
        calmSessionActive = false;
        const modal = bootstrap.Modal.getInstance(document.getElementById('quickCalmModal'));
        if (modal) {
            modal.hide();
        }
        
        socket.emit('calm_session_completed', {
            duration: 30,
            timestamp: new Date().toISOString(),
            effectiveness: 'high' // This could be user-rated
        });
        
        showToast('Calm session completed. Well done!', 'success', 'Session Complete');
    }

    // Initialize when document is ready
    document.addEventListener('DOMContentLoaded', function() {
        // Show initial status toast
        setTimeout(() => {
            showToast('Real-time monitoring activated. Sensors are streaming data.', 'success', 'System Ready');
        }, 1000);
        
        // Add event listeners for view toggle buttons
        const childViewBtn = document.getElementById('childViewBtn');
        const caregiverViewBtn = document.getElementById('caregiverViewBtn');
        
        if (childViewBtn && caregiverViewBtn) {
            childViewBtn.addEventListener('click', function() {
                showToast('Switched to Child View - Simple, calming interface', 'info', 'View Changed');
                socket.emit('view_changed', { view: 'child' });
                // Update UI for child view
                document.body.classList.add('child-view');
                document.body.classList.remove('caregiver-view');
            });
            
            caregiverViewBtn.addEventListener('click', function() {
                showToast('Switched to Caregiver View - Detailed monitoring', 'info', 'View Changed');
                socket.emit('view_changed', { view: 'caregiver' });
                // Update UI for caregiver view
                document.body.classList.add('caregiver-view');
                document.body.classList.remove('child-view');
            });
        }
        
        // Quick calm button
        const quickCalmBtn = document.getElementById('quickCalmBtn');
        if (quickCalmBtn) {
            quickCalmBtn.addEventListener('click', startCalmSession);
        }
        
        // Complete calm session button
        const completeCalmBtn = document.getElementById('completeCalmBtn');
        if (completeCalmBtn) {
            completeCalmBtn.addEventListener('click', completeCalmSession);
        }
        
        // Check if user profile exists
        checkUserProfile();
        
        // Request initial sensor data
        socket.emit('request_sensor_data');
        
        // Initialize charts if on dashboard
        if (typeof initializeCharts === 'function') {
            initializeCharts();
        }
    });
    
    async function checkUserProfile() {
        try {
            const response = await fetch('/api/profile');
            const data = await response.json();
            
            if (response.ok && data.profile && data.profile.age) {
                currentUserProfile = data.profile;
                console.log('User profile found:', data.profile);
                socket.emit('profile_loaded', data.profile);
            } else {
                // No profile found - suggest creating one
                setTimeout(() => {
                    showToast(
                        'Please set up your profile for personalized recommendations', 
                        'info', 
                        'Profile Setup Recommended'
                    );
                }, 3000);
            }
        } catch (error) {
            console.log('Error checking profile:', error);
        }
    }

    // Chart initialization function for dashboard
    function initializeCharts() {
        console.log('🎯 Initializing charts...');
        
        // Initialize sensor chart if element exists
        const sensorCtx = document.getElementById('sensorChart');
        if (sensorCtx && typeof Chart !== 'undefined') {
            window.sensorChart = new Chart(sensorCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Noise Level',
                            data: [],
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Light Level',
                            data: [],
                            borderColor: '#ffc107',
                            backgroundColor: 'rgba(255, 193, 7, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Motion Level',
                            data: [],
                            borderColor: '#0dcaf0',
                            backgroundColor: 'rgba(13, 202, 240, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Real-time Sensor Data'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
            console.log('✅ Sensor chart initialized');
        }

        // Initialize prediction chart if element exists
        const predictionCtx = document.getElementById('predictionChart');
        if (predictionCtx && typeof Chart !== 'undefined') {
            window.predictionChart = new Chart(predictionCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Overload Risk',
                        data: [],
                        borderColor: '#6610f2',
                        backgroundColor: 'rgba(102, 16, 242, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Overload Prediction Risk'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
            console.log('✅ Prediction chart initialized');
        }
        
        // Initialize data buffer
        window.dataBuffer = {
            timestamps: [],
            readings: {
                noise: [],
                light: [],
                motion: []
            },
            predictions: []
        };
    }

    // Data buffer management for charts
    function updateDataBuffer(sensorData, prediction) {
        if (!window.dataBuffer) {
            window.dataBuffer = {
                timestamps: [],
                readings: {
                    noise: [],
                    light: [],
                    motion: []
                },
                predictions: []
            };
        }

        const now = new Date();
        const timeLabel = now.toLocaleTimeString();

        // Add new data
        window.dataBuffer.timestamps.push(timeLabel);
        window.dataBuffer.readings.noise.push(sensorData.noise);
        window.dataBuffer.readings.light.push(sensorData.light);
        window.dataBuffer.readings.motion.push(sensorData.motion);
        window.dataBuffer.predictions.push(prediction * 100); // Convert to percentage

        // Keep only last 20 data points
        const maxDataPoints = 20;
        if (window.dataBuffer.timestamps.length > maxDataPoints) {
            window.dataBuffer.timestamps.shift();
            window.dataBuffer.readings.noise.shift();
            window.dataBuffer.readings.light.shift();
            window.dataBuffer.readings.motion.shift();
            window.dataBuffer.predictions.shift();
        }

        console.log('📊 Data buffer updated:', {
            timestamps: window.dataBuffer.timestamps.length,
            readings: window.dataBuffer.readings.noise.length,
            predictions: window.dataBuffer.predictions.length
        });

        // Update charts if they exist
        updateCharts();
    }

    // Update charts function
    function updateCharts() {
        if (!window.dataBuffer) return;

        // Update sensor chart
        if (window.sensorChart) {
            window.sensorChart.data.labels = window.dataBuffer.timestamps;
            window.sensorChart.data.datasets[0].data = window.dataBuffer.readings.noise;
            window.sensorChart.data.datasets[1].data = window.dataBuffer.readings.light;
            window.sensorChart.data.datasets[2].data = window.dataBuffer.readings.motion;
            window.sensorChart.update('none');
            console.log('✅ Sensor chart updated');
        } else {
            console.log('⚠️ Sensor chart not ready for update');
        }

        // Update prediction chart
        if (window.predictionChart) {
            window.predictionChart.data.labels = window.dataBuffer.timestamps;
            window.predictionChart.data.datasets[0].data = window.dataBuffer.predictions;
            window.predictionChart.update('none');
            console.log('✅ Prediction chart updated');
        } else {
            console.log('⚠️ Prediction chart not ready for update');
        }
    }

    // Risk display update function
    function updateRiskDisplay(prediction) {
        const riskElement = document.getElementById('riskLevel');
        const riskGauge = document.getElementById('riskGauge');
        
        if (riskElement) {
            const riskPercent = Math.round(prediction * 100);
            riskElement.textContent = riskPercent + '%';
            
            // Update color based on risk level
            if (riskPercent > 70) {
                riskElement.className = 'risk-high';
            } else if (riskPercent > 30) {
                riskElement.className = 'risk-medium';
            } else {
                riskElement.className = 'risk-low';
            }
        }
        
        if (riskGauge) {
            riskGauge.style.width = Math.round(prediction * 100) + '%';
        }
    }

    // Export functions for use in other scripts
    window.socketUtils = {
        showToast,
        showLoading,
        hideLoading,
        formatTime,
        updateSensorDisplays,
        startCalmSession,
        updateDataBuffer,
        updateCharts,
        updateRiskDisplay,
        initializeCharts
    };
    </script>
    
    {% block extra_scripts %}{% endblock %}
</body>
</html>
