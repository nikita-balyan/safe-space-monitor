<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calming Activities - Safe Space Monitor</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Custom Activities CSS -->
    <link href="{{ url_for('static', filename='css/activities.css') }}" rel="stylesheet">
    
    <style>
        .activity-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
            border-radius: 15px;
            overflow: hidden;
        }
        .activity-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .activity-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        .difficulty-badge {
            font-size: 0.75rem;
        }
        .voice-option {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 10px;
            margin: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
        }
        .voice-option.selected {
            border-color: #007bff;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        }
        .voice-option:hover {
            border-color: #adb5bd;
            transform: translateY(-2px);
        }
        .animation-preview {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2.5rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        .activity-modal .modal-dialog {
            max-width: 800px;
        }
        .instruction-step {
            padding: 12px 15px;
            border-left: 4px solid #dee2e6;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 0 8px 8px 0;
            transition: all 0.3s ease;
        }
        .instruction-step.active {
            background: #e3f2fd;
            border-left-color: #2196f3;
            transform: translateX(5px);
        }
        .instruction-step.completed {
            background: #e8f5e8;
            border-left-color: #4caf50;
            opacity: 0.8;
        }
        .phase-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .phase-inhale { background-color: #28a745; }
        .phase-hold { background-color: #ffc107; }
        .phase-exhale { background-color: #dc3545; }
        .phase-hold-empty { background-color: #6c757d; }
        .phase-prepare { background-color: #17a2b8; }
        
        .accessibility-icons i {
            transition: all 0.3s ease;
        }
        .accessibility-icons i:hover {
            transform: scale(1.2);
            color: #007bff !important;
        }
        
        /* Animations */
        @keyframes breatheIn {
            0% { transform: scale(0.8); opacity: 0.7; }
            100% { transform: scale(1.2); opacity: 1; }
        }
        @keyframes breatheOut {
            0% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0.7; }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-12px); }
        }
        @keyframes celebrate {
            0% { transform: scale(1); }
            25% { transform: scale(1.1) rotate(5deg); }
            50% { transform: scale(1.15) rotate(-5deg); }
            75% { transform: scale(1.1) rotate(5deg); }
            100% { transform: scale(1); }
        }
        
        .session-controls .btn {
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .session-controls .btn:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <!-- Activity Dashboard Content -->
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3 mb-1">
                            <i class="fas fa-heartbeat text-primary me-2"></i>
                            Calming Activities
                        </h1>
                        <p class="text-muted mb-0">Guided exercises to help with sensory regulation</p>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" id="voiceSettingsBtn">
                            <i class="fas fa-volume-up me-1"></i>Voice Settings
                        </button>
                        <button class="btn btn-outline-secondary" id="activityStatsBtn">
                            <i class="fas fa-chart-bar me-1"></i>Statistics
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Modal -->
        <div class="modal fade" id="activityStatsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-chart-bar me-2"></i>Activity Statistics
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row text-center">
                            <div class="col-md-3 mb-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body">
                                        <h3 id="totalSessions">0</h3>
                                        <p class="mb-0">Total Sessions</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body">
                                        <h3 id="totalDuration">0</h3>
                                        <p class="mb-0">Minutes Practiced</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body">
                                        <h3 id="averageRating">0.0</h3>
                                        <p class="mb-0">Average Rating</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card bg-warning text-white">
                                    <div class="card-body">
                                        <h3 id="completionRate">0%</h3>
                                        <p class="mb-0">Completion Rate</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <h6>Recent Sessions</h6>
                                <div id="recentSessions" class="list-group">
                                    <!-- Recent sessions will be populated -->
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Effectiveness by Activity Type</h6>
                                <div id="effectivenessChart">
                                    <!-- Effectiveness chart will be populated -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Voice Settings Modal -->
        <div class="modal fade" id="voiceSettingsModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-volume-up me-2"></i>Voice Settings
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Voice Selection</label>
                            <div id="voiceOptions" class="d-flex flex-wrap justify-content-center">
                                <!-- Voice options will be populated by JavaScript -->
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Speech Rate</label>
                                <input type="range" class="form-range" id="speechRate" min="0.5" max="2" step="0.1" value="1">
                                <div class="text-center">
                                    <small id="speechRateValue" class="text-muted">Normal Speed (1.0x)</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Volume</label>
                                <input type="range" class="form-range" id="volume" min="0" max="1" step="0.1" value="0.8">
                                <div class="text-center">
                                    <small id="volumeValue" class="text-muted">80% Volume</small>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="form-label">Visual Theme</label>
                            <select class="form-select" id="visualTheme">
                                <option value="default">Default Theme</option>
                                <option value="calm">Calm Colors</option>
                                <option value="nature">Nature Theme</option>
                                <option value="ocean">Ocean Theme</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="saveVoiceSettings">Save Settings</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Grid -->
        <div class="row g-4" id="activitiesGrid">
            <!-- Activities will be populated by JavaScript -->
            <div class="col-12 text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading activities...</span>
                </div>
                <p class="text-muted mt-2">Loading calming activities...</p>
            </div>
        </div>

        <!-- Activity Session Modal -->
        <div class="modal fade" id="activitySessionModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="activitySessionTitle">
                            <span id="activityEmoji"></span>
                            <span id="activityName"></span>
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <!-- Animation Preview -->
                                <div class="text-center mb-4">
                                    <div class="animation-preview" id="animationContainer">
                                        <i class="fas fa-wind" id="animationIcon"></i>
                                    </div>
                                    <div class="mt-3">
                                        <h4 id="currentInstruction" class="text-center">Get ready to begin...</h4>
                                        <div class="progress mt-3" style="height: 8px;">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                                 id="sessionProgress" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted d-block mt-2 text-center" id="timeRemaining">
                                            Starting soon...
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <!-- Instructions -->
                                <div class="mb-4">
                                    <h6 class="border-bottom pb-2">
                                        <i class="fas fa-list-ol me-2"></i>Instructions
                                    </h6>
                                    <div id="instructionsList" style="max-height: 300px; overflow-y: auto;">
                                        <!-- Instructions will be populated by JavaScript -->
                                    </div>
                                </div>
                                
                                <!-- Controls -->
                                <div class="session-controls">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-success btn-lg" id="startActivityBtn">
                                            <i class="fas fa-play me-2"></i>Start Activity
                                        </button>
                                        <button class="btn btn-warning btn-lg d-none" id="pauseActivityBtn">
                                            <i class="fas fa-pause me-2"></i>Pause
                                        </button>
                                        <button class="btn btn-secondary btn-lg d-none" id="resumeActivityBtn">
                                            <i class="fas fa-play me-2"></i>Resume
                                        </button>
                                        <button class="btn btn-outline-danger" id="stopActivityBtn">
                                            <i class="fas fa-stop me-2"></i>Stop Activity
                                        </button>
                                    </div>
                                    
                                    <!-- Keyboard Shortcuts Help -->
                                    <div class="mt-3 p-3 bg-light rounded">
                                        <small class="text-muted">
                                            <i class="fas fa-keyboard me-1"></i>
                                            <strong>Keyboard Shortcuts:</strong> 
                                            Spacebar to pause/resume • Escape to stop
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Start Section -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-bolt me-2 text-warning"></i>Quick Start
                        </h5>
                        <p class="card-text text-muted">
                            Need immediate calm? Try these quick activities:
                        </p>
                        <div class="row g-2" id="quickActivities">
                            <!-- Quick activities will be populated -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Enhanced Activities JavaScript -->
    <script src="{{ url_for('static', filename='js/activities.js') }}"></script>

    <script>
        // Additional initialization for statistics modal
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize statistics button
            const statsBtn = document.getElementById('activityStatsBtn');
            if (statsBtn) {
                statsBtn.addEventListener('click', function() {
                    loadActivityStatistics();
                    const modal = new bootstrap.Modal(document.getElementById('activityStatsModal'));
                    modal.show();
                });
            }

            // Load quick activities
            loadQuickActivities();
        });

        async function loadActivityStatistics() {
            try {
                const response = await fetch('/api/activities/stats');
                const stats = await response.json();
                
                // Update statistics display
                document.getElementById('totalSessions').textContent = stats.total_sessions;
                document.getElementById('totalDuration').textContent = Math.round(stats.total_duration / 60);
                document.getElementById('averageRating').textContent = stats.average_rating;
                document.getElementById('completionRate').textContent = Math.round(stats.completion_rate * 100) + '%';
                
                // Update recent sessions
                const recentSessions = document.getElementById('recentSessions');
                recentSessions.innerHTML = stats.recent_sessions.map(session => `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${session.exercise}</h6>
                            <small>${session.duration}s</small>
                        </div>
                        <p class="mb-1">Rating: ${'★'.repeat(session.rating)}${'☆'.repeat(5-session.rating)}</p>
                        <small class="text-muted">${new Date(session.date).toLocaleDateString()}</small>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        async function loadQuickActivities() {
            try {
                const response = await fetch('/api/activities');
                const activities = await response.json();
                
                // Get 3 quick activities (shortest duration)
                const quickActivities = activities
                    .sort((a, b) => a.duration - b.duration)
                    .slice(0, 3);
                
                const quickContainer = document.getElementById('quickActivities');
                quickContainer.innerHTML = quickActivities.map(activity => `
                    <div class="col-md-4">
                        <div class="card h-100 quick-activity-card">
                            <div class="card-body text-center">
                                <div class="activity-icon" style="color: ${activity.color}">
                                    ${activity.emoji}
                                </div>
                                <h6 class="card-title">${activity.name}</h6>
                                <p class="card-text small text-muted">${activity.duration}s • ${activity.difficulty}</p>
                                <button class="btn btn-outline-primary btn-sm start-activity" 
                                        data-activity-id="${activity.id}">
                                    Start Now
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading quick activities:', error);
            }
        }

        // Enhanced toast function
        function showToast(message, type = 'info') {
            // Use the enhanced activity manager if available
            if (window.activityManager) {
                window.activityManager.showToast(message, type);
            } 
            // Fallback to socket utils
            else if (window.socketUtils && window.socketUtils.showToast) {
                window.socketUtils.showToast(message, type);
            } 
            // Final fallback
            else {
                const toastContainer = document.createElement('div');
                toastContainer.className = 'position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '1060';
                
                const toast = document.createElement('div');
                toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'primary'} border-0`;
                toast.setAttribute('role', 'alert');
                toast.setAttribute('aria-live', 'assertive');
                toast.setAttribute('aria-atomic', 'true');
                
                toast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                `;
                
                toastContainer.appendChild(toast);
                document.body.appendChild(toastContainer);
                
                const bsToast = new bootstrap.Toast(toast);
                bsToast.show();
                
                toast.addEventListener('hidden.bs.toast', () => {
                    toastContainer.remove();
                });
            }
        }

        // Handle page visibility changes for better TTS management
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && window.activityManager && window.activityManager.isActivityActive) {
                // Auto-pause activities when tab is not visible
                if (!window.activityManager.isPaused) {
                    window.activityManager.pauseActivitySession();
                    showToast('Activity auto-paused (tab not visible)', 'warning');
                }
            }
        });

        // Service Worker registration for offline capability (future enhancement)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('SW registered: ', registration);
                })
                .catch(registrationError => {
                    console.log('SW registration failed: ', registrationError);
                });
        }
    </script>
</body>
</html>